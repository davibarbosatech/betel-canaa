<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos - Betel Canaã</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
        :root {
            --cor-padrao: #e8c39e; --cor-padrao-hover: #fff6ed; --cor-fonte: #000;
            --cor-fonte-p: #555; --cor-btn: #9e6730; --cor-btn-hover: #7a4f24;
            --cor-btn-fonte: #fff; --cor-fonte-corpo: #555; --cor-fonte-leve: #e8c39e;
            --cor-branco: #ffffff; --cor-cinza: #f5f5f5; --cor-cinza-escuro: #e0e0e0;
            --sombra: 0 4px 6px rgba(0, 0, 0, 0.1); --sombra-hover: 0 8px 15px rgba(0, 0, 0, 0.15);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--cor-cinza); color: var(--cor-fonte); line-height: 1.6; min-height: 100vh; display: flex; flex-direction: column; }

        /* HEADER */
        header { background: radial-gradient(#fff6ed, #e8c39e); box-shadow: var(--sombra); position: sticky; top: 0; z-index: 100; }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 5%; max-width: 1400px; margin: 0 auto; position: relative; }
        .logo img { width: 140px; height: auto; object-fit: contain; display: block; }
        #menu-mobile { flex: 1; text-align: right; }
        .nav-links { display: flex; list-style: none; gap: 30px; justify-content: flex-end; align-items: center; }
        .nav-links a { text-decoration: none; color: var(--cor-fonte); font-weight: 500; padding: 8px 0; transition: color 0.3s ease; }
        .nav-links a:hover { color: var(--cor-btn); }
        .header-icons { display: flex; align-items: center; gap: 15px; margin-left: 20px; }
        .carrinho-icon img { width: 30px; height: 30px; cursor: pointer; }
        .menu-icon { display: none; font-size: 35px; color: var(--cor-fonte); cursor: pointer; }

        /* PRODUTOS */
        section { max-width: 1400px; margin: 40px auto; padding: 0 20px; flex: 1; }
        section h2 { text-align: center; font-size: 32px; margin-bottom: 30px; color: var(--cor-fonte); position: relative; padding-bottom: 15px; }
        section h2::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 80px; height: 3px; background-color: var(--cor-btn); border-radius: 2px; }

        .filtros-categoria { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; flex-wrap: wrap; }
        .filtro-btn { padding: 10px 20px; background-color: var(--cor-branco); border: 2px solid var(--cor-btn); color: var(--cor-btn); border-radius: 30px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; }
        .filtro-btn:hover { background-color: var(--cor-padrao-hover); transform: translateY(-2px); }
        .filtro-btn.active { background-color: var(--cor-btn); color: var(--cor-branco); }

        .produtos-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; margin-bottom: 50px; }
        .produto-card { background-color: var(--cor-branco); border-radius: 10px; overflow: hidden; box-shadow: var(--sombra); transition: transform 0.3s ease, box-shadow 0.3s ease; display: flex; flex-direction: column; width: 100%; }
        .produto-card:hover { transform: translateY(-10px); box-shadow: var(--sombra-hover); }
        .produto-imagem { width: 100%; height: 400px; object-fit: cover; object-position: top center; transition: transform 0.5s ease; }
        .produto-card:hover .produto-imagem { transform: scale(1.15); }
        .produto-info { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .produto-categoria { color: var(--cor-padrao); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .produto-nome { font-size: 18px; font-weight: 600; margin-bottom: 10px; color: var(--cor-fonte); }
        .produto-descricao { color: var(--cor-fonte-p); font-size: 14px; margin-bottom: 15px; flex-grow: 1; }
        .produto-preco { font-size: 20px; font-weight: 700; color: var(--cor-btn); margin-bottom: 15px; }
        .btn-adicionar { background-color: var(--cor-btn); color: var(--cor-branco); border: none; padding: 12px 20px; border-radius: 5px; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease; text-align: center; display: block; width: 100%; margin-top: auto; }
        .btn-adicionar:hover { background-color: var(--cor-btn-hover); }
        .sem-produtos { text-align: center; padding: 40px; color: var(--cor-fonte-p); grid-column: 1 / -1; }
        .loading { text-align: center; font-size: 18px; padding: 40px; width: 100%; grid-column: 1 / -1; }

        footer { background-color: #5a371b; color: var(--cor-branco); text-align: center; padding: 30px 20px; margin-top: auto; }

        @media (max-width: 900px) { .produtos-grid { grid-template-columns: repeat(2, 1fr); gap: 20px; } }
        @media (max-width: 768px) {
            .menu-icon { display: block; } 
            #menu-mobile { position: absolute; top: 100%; right: 0; width: 100%; background: radial-gradient(#fff6ed, #e8c39e); box-shadow: 0 5px 15px rgba(0,0,0,0.1); max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; z-index: 1000; }
            #menu-mobile.active { max-height: 350px; }
            .nav-links { flex-direction: column; width: 100%; padding: 20px 0; gap: 0; }
            .nav-links li { width: 100%; text-align: center; }
            .nav-links a { display: block; padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); }
        }
        @media (max-width: 600px) {
            .produtos-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .produto-imagem { height: 280px; }
            .produto-info { padding: 12px; }
            .produto-nome { font-size: 15px; }
            .btn-adicionar { padding: 10px; font-size: 13px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="navbar">
            <div class="logo"><a href="home.html"><img src="assets/img/Logo fundo trans.png" alt="Loja Virtual Betel Canaã"></a></div>
            <nav id="menu-mobile">
                <ul class="nav-links" id="menu-itens">
                    <li><a href="home.html">Home</a></li>
                    <li><a href="produtos.html">Produtos</a></li>
                    <li><a href="carrinho.html">Carrinho</a></li>
                    <li id="login-item"><a href="login.html">Login</a></li>
                    <li><a href="painel-admin.html">Admin</a></li>
                </ul>
            </nav>
            <div class="header-icons">
                <a href="carrinho.html" class="carrinho-icon"><img src="assets/img/sacola de compras.png" alt="Carrinho"></a>
                <ion-icon name="menu-outline" class="menu-icon" onclick="toggleMenu()"></ion-icon>
            </div>
        </div>
    </header>

    <section>
        <h2>Nossos Produtos</h2>
        <div class="filtros-categoria">
            <button class="filtro-btn active" data-categoria="todos">Todos</button>
            <button class="filtro-btn" data-categoria="masculino">Masculino</button>
            <button class="filtro-btn" data-categoria="feminino">Feminino</button>
            <button class="filtro-btn" data-categoria="infantil">Infantil</button>
        </div>
        <div class="produtos-grid" id="produtos-container"><div class="loading">Carregando produtos...</div></div>
    </section>

    <footer><p>&copy; 2025 Betel Canaã. Todos os direitos reservados.</p></footer>

    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

    <script>
        let todosProdutos = [];
        const produtosContainer = document.getElementById('produtos-container');
        const filtroBtns = document.querySelectorAll('.filtro-btn');

        document.addEventListener('DOMContentLoaded', () => {
             atualizarInterfaceUsuario();
             buscarProdutos();
        });

        function toggleMenu() {
            const nav = document.getElementById('menu-mobile');
            nav.classList.toggle('active');
        }

        function atualizarInterfaceUsuario() {
            const token = localStorage.getItem('token');
            const loginItem = document.getElementById('login-item');
            const menu = document.getElementById('menu-itens');

            if (token) {
                if (!document.getElementById('link-minhas-compras')) {
                    const liCompras = document.createElement('li');
                    liCompras.id = 'link-minhas-compras';
                    liCompras.innerHTML = '<a href="meus-pedidos.html">Minhas Compras</a>';
                    menu.insertBefore(liCompras, loginItem);
                }
                if (loginItem) loginItem.innerHTML = '<a href="#" onclick="logout(event)">Sair</a>';
            }
        }

        function logout(e) {
            if(e) e.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('usuario_nome');
            window.location.href = 'login.html';
        }

        async function buscarProdutos() {
            try {
                const response = await fetch('/api/produtos');
                if (!response.ok) throw new Error('Erro ao buscar produtos');
                todosProdutos = await response.json();
                renderizarProdutos('todos');
            } catch (error) {
                console.error('Erro:', error);
                produtosContainer.innerHTML = '<div class="sem-produtos">Erro ao carregar produtos.</div>';
            }
        }

        function renderizarProdutos(categoria = 'todos') {
            produtosContainer.innerHTML = '';
            const produtosFiltrados = categoria === 'todos' ? todosProdutos : todosProdutos.filter(p => p.categoria && p.categoria.toLowerCase() === categoria.toLowerCase());
            
            if (produtosFiltrados.length === 0) {
                produtosContainer.innerHTML = '<div class="sem-produtos">Nenhum produto encontrado.</div>';
                return;
            }
            
            produtosFiltrados.forEach(produto => {
                const imagemSrc = produto.imagem ? produto.imagem : 'assets/img/sem-foto.png';
                const produtoCard = document.createElement('div');
                produtoCard.className = 'produto-card';
                produtoCard.innerHTML = `
                    <a href="produto-detalhes.html?id=${produto.id}">
                        <img src="${imagemSrc}" alt="${produto.nome}" class="produto-imagem" onerror="this.src='https://via.placeholder.com/300?text=Sem+Foto'">
                    </a>
                    <div class="produto-info">
                        <span class="produto-categoria">${produto.categoria || 'Geral'}</span>
                        <h3 class="produto-nome">${produto.nome}</h3>
                        <p class="produto-descricao">${produto.descricao || ''}</p>
                        <div class="produto-preco">R$ ${produto.preco.toFixed(2)}</div>
                        <button class="btn-adicionar" onclick="adicionarAoCarrinho(${produto.id})">Adicionar ao Carrinho</button>
                    </div>
                `;
                produtosContainer.appendChild(produtoCard);
            });
        }

        // === ADICIONAR AO CARRINHO CORRIGIDO ===
        function adicionarAoCarrinho(id) {
            const produto = todosProdutos.find(p => p.id === id);
            if (produto) {
                let carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
                if (!Array.isArray(carrinho)) carrinho = [];

                const itemExistente = carrinho.find(item => item.productId === id);

                if (itemExistente) {
                    itemExistente.quantidade += 1;
                    itemExistente.subtotal = itemExistente.quantidade * itemExistente.preco;
                } else {
                    carrinho.push({
                        productId: produto.id,
                        nome: produto.nome,
                        preco: produto.preco,
                        imagem: produto.imagem,
                        categoria: produto.categoria,
                        quantidade: 1,
                        subtotal: produto.preco
                    });
                }
                localStorage.setItem('carrinho', JSON.stringify(carrinho));
                if(confirm(`${produto.nome} adicionado ao carrinho!\nDeseja ir para o carrinho agora?`)) {
                    window.location.href = 'carrinho.html';
                }
            }
        }

        filtroBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                filtroBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const categoria = btn.getAttribute('data-categoria');
                renderizarProdutos(categoria);
            });
        });
    </script>
</body>
</html>